# View/Template/Page Migrations script for ZSH
#
# package:   Auto
# author:    Egor Kovetskiy <e.kovetskiy@office.ngs.ru>
# copyright: 2014 NGS

PHP_CLI="/data/soft/bin/php scripts/cli.php"

# Контроль передается в контроллер Auto_Migrate, в котором выполняется метод findHelper
function _list ()
{
    QUERY="${PHP_CLI} --controller Migrate --method findHelper --entity $1"
    if [ ! -z $2 ]; then
        QUERY="$QUERY --name $2"
    fi

    eval ${QUERY}
}

# шорткат для листинга представлений
function _listView ()
{
    reply=(`_list "views" $1`)
}

# шорткат для листинга страниц
function _listPage ()
{
    reply=(`_list "pages" $1`)
}


# шорткат для листинга шаблонов
function _listTpl ()
{
    reply=(`_list "tpl" $1`)
}

# функция для получения текущей ветки
function _getBranch()
{
    eval "git symbolic-ref HEAD 2>/dev/null | cut -d / -f 3"
}

# функция для получения пространства имен по названию шаблона/вью/страницы
function _getNameSpace()
{
    eval "find scripts/migrations -name '$1.php' | cut -d / -f4"
}

# функция для осуществления непосредственной миграции
function _migrate()
{
    ENTITY=$1
    NAME=$2

    # пытаемся найти такой namespace
    NAMESPACE=(`_getNameSpace ${NAME}`)

    # если он пуст, то спрашиваем
    if [ -z ${NAMESPACE} ]; then
        vared -p "Namespace: " NAMESPACE
    fi

    BRANCH=`_getBranch`
    QUERY="${PHP_CLI} --controller Migrate --method create --entity ${ENTITY} --namespace ${NAMESPACE} --name ${NAME} --branch ${BRANCH}"
    eval ${QUERY}
}
# шорткат для миграции страниц
function migratePage ()
{
    eval "_migrate \"pages\" $1"
}

# шорткат для миграции представлений
function migrateView ()
{
    eval "_migrate \"views\" $1"
}

# шорткат для миграции шаблонов
function migrateTpl ()
{
    eval "_migrate \"tpl\" $1"
}

# zsh-настройка автокомплитов
# todo: pages
compctl -K _listView migrateView
compctl -K _listTpl migrateTpl

compctl -K _listPage migratePage
